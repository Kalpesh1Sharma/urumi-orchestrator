<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Urumi Orchestrator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { background-color: #f8fafc; font-family: sans-serif; }
        .glass-panel { background: white; border: 1px solid #e2e8f0; }
        .console-bg { background-color: #0f172a; color: #38bdf8; font-family: monospace; }
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(74, 222, 128, 0); }
            100% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0); }
        }
        .status-dot { animation: pulse-green 2s infinite; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // ICONS
        const IconServer = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect><rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect><line x1="6" y1="6" x2="6.01" y2="6"></line><line x1="6" y1="18" x2="6.01" y2="18"></line></svg>;
        const IconGlobe = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>;
        const IconLink = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>;
        const IconTrash = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>;
        const IconTerminal = () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="4 17 10 11 4 5"></polyline><line x1="12" y1="19" x2="20" y2="19"></line></svg>;
        const IconUpgrade = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="16 12 12 8 8 12"></polyline><line x1="12" y1="16" x2="12" y2="8"></line></svg>;
        const IconRollback = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="1 4 1 10 7 10"></polyline><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path></svg>;


        function App() {
            const [stores, setStores] = useState([]);
            const [logs, setLogs] = useState([]);
            const [newStoreName, setNewStoreName] = useState("");
            const [isDeploying, setIsDeploying] = useState(false);

            // API CONNECTORS
            const fetchData = async () => {
                try {
                    const [storesRes, logsRes] = await Promise.all([
                        fetch('/api/stores'),
                        fetch('/api/logs')
                    ]);
                    setStores(await storesRes.json());
                    setLogs(await logsRes.json());
                } catch (err) { console.error("API Error:", err); }
            };

            useEffect(() => {
                fetchData();
                const interval = setInterval(fetchData, 2000);
                return () => clearInterval(interval);
            }, []);

            // ACTIONS
            const handleDeploy = async () => {
                if (!newStoreName) return;
                setIsDeploying(true);
                await fetch('/api/stores', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ storeName: newStoreName })
                });
                setNewStoreName("");
                setTimeout(() => setIsDeploying(false), 2000);
            };

            const handleDelete = async (id) => {
                if(!confirm(`Delete store ${id}?`)) return;
                await fetch(`/api/stores/${id}`, { method: 'DELETE' });
            };

            const handleUpgrade = async (id) => {
                await fetch(`/api/stores/${id}/upgrade`, { method: 'PUT' });
            };

            const handleRollback = async (id) => {
                if(!confirm(`Rollback ${id} to previous version?`)) return;
                await fetch(`/api/stores/${id}/rollback`, { method: 'PUT' });
            };

            const handleLinkDomain = async (id) => {
                const domain = prompt(`Enter custom domain for ${id} (e.g., mybrand.com):`);
                if (!domain) return;
                await fetch(`/api/stores/${id}/domain`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ domain })
                });
                alert(`Domain ${domain} linked! DNS propagation may take 24h.`);
            };

            return (
                <div className="min-h-screen p-8 max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">
                    
                    {/* LEFT COLUMN */}
                    <div className="lg:col-span-2 space-y-6">
                        <div className="glass-panel p-6 rounded-2xl flex justify-between items-center shadow-sm">
                            <div className="flex items-center gap-4">
                                <div className="h-12 w-12 bg-indigo-600 rounded-xl flex items-center justify-center text-white">
                                    <IconServer />
                                </div>
                                <div>
                                    <h1 className="text-2xl font-bold text-slate-800">Store Orchestrator</h1>
                                    <p className="text-slate-500 text-sm">GKE Cloud Platform â€¢ v6.5</p>
                                </div>
                            </div>
                            <div className="flex items-center gap-2 px-4 py-2 bg-white rounded-full border border-slate-200">
                                <div className="w-2 h-2 bg-green-500 rounded-full status-dot"></div>
                                <span className="text-xs font-semibold text-slate-600">System Online</span>
                            </div>
                        </div>

                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                            <label className="block text-sm font-medium text-slate-700 mb-2">Launch New Storefront</label>
                            <div className="flex gap-4">
                                <input 
                                    type="text" 
                                    value={newStoreName}
                                    onChange={(e) => setNewStoreName(e.target.value)}
                                    placeholder="e.g. nike-store-nyc"
                                    className="flex-1 px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-indigo-500 focus:outline-none"
                                />
                                <button 
                                    onClick={handleDeploy}
                                    disabled={isDeploying}
                                    className={`px-6 py-3 rounded-xl font-semibold text-white transition-all ${isDeploying ? 'bg-slate-400' : 'bg-indigo-600 hover:bg-indigo-700 shadow-lg shadow-indigo-200'}`}
                                >
                                    {isDeploying ? 'Queued...' : 'Deploy Store'}
                                </button>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 gap-4">
                            {stores.length === 0 && <div className="text-center py-12 text-slate-400">No stores deployed yet.</div>}
                            {stores.map(store => (
                                <div key={store.name} className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition-all">
                                    <div className="flex justify-between items-start mb-4">
                                        <div>
                                            <h3 className="text-lg font-bold text-slate-800 flex items-center gap-2">
                                                {store.name}
                                                <span className="px-2 py-0.5 rounded text-xs font-mono bg-green-100 text-green-700">RUNNING</span>
                                            </h3>
                                            <p className="text-xs text-slate-400 font-mono mt-1">ID: {store.namespace}</p>
                                        </div>
                                        <div className="text-right">
                                            <div className="text-xs text-slate-400">Revision</div>
                                            <div className="font-mono font-bold text-indigo-600">v{store.revision || '1'}</div>
                                        </div>
                                    </div>

                                    {/* Action Buttons */}
                                    <div className="grid grid-cols-2 gap-3 mb-4">
                                        <button onClick={() => handleUpgrade(store.name)} className="flex items-center justify-center gap-2 px-4 py-2 bg-indigo-50 text-indigo-700 rounded-lg hover:bg-indigo-100 font-medium text-sm transition-colors">
                                            <IconUpgrade /> Upgrade
                                        </button>
                                        <button onClick={() => handleRollback(store.name)} className="flex items-center justify-center gap-2 px-4 py-2 bg-orange-50 text-orange-700 rounded-lg hover:bg-orange-100 font-medium text-sm transition-colors">
                                            <IconRollback /> Rollback
                                        </button>
                                    </div>

                                    {/* DOMAIN & ACCESS BUTTONS */}
                                    <div className="flex justify-between items-center pt-4 border-t border-slate-50 gap-4">
                                        <div className="flex gap-3">
                                            {store.accessUrl ? (
                                                <a href={store.accessUrl} target="_blank" className="flex items-center gap-2 px-4 py-2 bg-indigo-50 text-indigo-700 rounded-lg hover:bg-indigo-100 font-medium text-sm transition-colors">
                                                    <IconGlobe /> Open Store
                                                </a>
                                            ) : (
                                                <span className="text-sm text-slate-400 flex items-center gap-2">Provisioning...</span>
                                            )}
                                            
                                            {/* POINT 4: THE LINK DOMAIN BUTTON */}
                                            <button onClick={() => handleLinkDomain(store.name)} className="flex items-center gap-2 px-4 py-2 border border-slate-200 text-slate-600 rounded-lg hover:bg-slate-50 font-medium text-sm transition-colors">
                                                <IconLink /> Link Domain
                                            </button>
                                        </div>

                                        <button onClick={() => handleDelete(store.name)} className="text-red-400 hover:text-red-600 p-2 rounded-lg hover:bg-red-50 transition-colors">
                                            <IconTrash />
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* RIGHT COLUMN: LOGS */}
                    <div className="lg:col-span-1">
                        <div className="bg-slate-900 rounded-2xl shadow-xl overflow-hidden flex flex-col h-[600px] border border-slate-800">
                            <div className="p-4 bg-slate-800 border-b border-slate-700 flex justify-between items-center">
                                <span className="text-slate-200 font-mono text-sm flex items-center gap-2">
                                    <IconTerminal /> System Activity
                                </span>
                                <div className="flex gap-1">
                                    <div className="w-2.5 h-2.5 rounded-full bg-red-500"></div>
                                    <div className="w-2.5 h-2.5 rounded-full bg-yellow-500"></div>
                                    <div className="w-2.5 h-2.5 rounded-full bg-green-500"></div>
                                </div>
                            </div>
                            <div className="flex-1 overflow-y-auto p-4 space-y-3 font-mono text-xs custom-scrollbar">
                                {logs.map((log) => (
                                    <div key={log.id} className="border-l-2 border-slate-700 pl-3 py-1">
                                        <div className="flex items-center justify-between mb-1">
                                            <span className={`${
                                                log.type === 'ERROR' ? 'text-red-400' : 
                                                log.type === 'SUCCESS' ? 'text-green-400' : 
                                                log.type === 'WARNING' ? 'text-yellow-400' : 'text-blue-400'
                                            } font-bold`}>
                                                {log.type}
                                            </span>
                                            <span className="text-slate-600 text-[10px]">{new Date(log.timestamp).toLocaleTimeString()}</span>
                                        </div>
                                        <p className="text-slate-300 leading-relaxed">
                                            {log.storeId && <span className="text-indigo-400">[{log.storeId}] </span>}
                                            {log.message}
                                        </p>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>

                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>